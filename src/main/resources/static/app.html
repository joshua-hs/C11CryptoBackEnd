<!doctype html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet"
      integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous">
    <link href="styles.css" rel="stylesheet" />
    <link href="bootstrapmods.css" rel="stylesheet" />
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
    
    <style>
    
* {
	font-family: Roboto;
}


#assetDropdownHeader {
    width: 150px;
}

#increasePositionOptions {
	text-align: center;
}

#decreasePositionOptions {
	text-align: center;
}

#footer {  
    padding: 10px;  
    display: flex;
    align-items: center;
    justify-content: center;
    margin-left: auto;
}

#github {
    margin-right: 40px;
}

#trade-options {
	margin-top: 30px;
}

#trade-container {
	text-align: center;
}

#or {
    margin-top: 10px;
}

#main-heading {
    margin-top: 70px;
    text-align: center;
}

.gains {
	color: green;
}

.loss {
	color: red;
}

.main-table {
	text-align: center;
}

.main-container {
	display: flex;
	margin-top: 50px;
	width: 100%;
	height: 75vh;
}

.left-container {
	position: relative;
    display: flex;
    float: left;
    margin-top: 50px;
    margin-left: 10vw;
    flex-direction: column;
    width: 160vw;
    
}

.right-container {
	position: relative;
    display: flex;
    float: right;
    margin-top: 50px;
    margin-left: 7vw;
    margin-right: 5vw;
    padding-top: 40px;
    flex-direction: column;
    width: 1000px;
    height: 500px;
    border: 2px solid cornflowerblue;
    border-radius: 30px;
}

.purchasing-desk {
	margin-left: auto;
	margin-right: auto;
}

.trade-buttons {
	position: absolute;
	margin-bottom: 40px;
	bottom: 0;
}

    	
	</style>
    <title>C11 Crypto</title>
  </head>

  <body>
    <!-- MODAL/ORDER CONFIRMATION BOX -->
    <div class="modal fade" id="quoteModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
      aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Trade confirmation</h5>
            </button>
          </div>
          <div id="quoteModalBody" class="modal-body">
            <h6>Please confirm below details:</h6>
            <br>
            <h6 id="modalAssetName"></h6>
            <h6 id="modalQuantity"></h6>
            <h6 id="modalPrice"></h6>
            <h6 id="modalCost"></h6>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
            <button id="placeTrade" type="button" class="btn btn-primary">Place trade</button>
          </div>
        </div>
      </div>
    </div>

    <!-- INCREASE POSITION MODAL -->
    <div class="modal fade" id="increasePositionModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
      aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Increase position</h5>
            </button>
          </div>
          <form id="increasePositionOptions">
            <br>
            <h6 id="increasePositionAssetLastTradedPrice"></h6>
            <br>
            <h6 id="increasePositionCurrentUnits"></h6>
            <br>
            <h6 id="increasePositionCurrentValue"></h6>
            <br>
            <label class="form-label"><b>Units to purchase</b></label>
            <br>
            <input id="increasePositionQuantityBox" placeholder="E.g. 2, 5, 30" class="form-control">
            <br>
            <br>
          </form>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
            <button id="increasePositionExecute" type="button" class="btn btn-primary">Purchase</button>
          </div>
        </div>
      </div>
    </div>

    <!-- REDUCE POSITION MODAL -->
    <div class="modal fade" id="decreasePositionModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
      aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Reduce position</h5>
            </button>
          </div>
          <form id="decreasePositionOptions">
            <br>
            <h6 id="decreasePositionAssetLastTradedPrice"></h6>
            <br>
            <h6 id="decreasePositionCurrentUnits"></h6>
            <br>
            <h6 id="decreasePositionCurrentValue"></h6>
            <br>
            <input class="form-check-input" type="checkbox" value="1" id="sellEntireHoldingCheckBox"
              unchecked="unchecked">
            <label class="form-check-label" for="sellEntireHoldingCheckBox">
              <b>Sell entire holding (realize profit/loss)</b>
            </label>
            <br>
            <br>
            <label class="form-label"><b>Units to sell</b></label>
            <br>
            <input id="decreasePositionQuantityBox" placeholder="E.g. 2, 5, 30" class="form-control">
            <br>
            <br>
          </form>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
            <button id="decreasePositionExecute" type="button" class="btn btn-primary">Sell</button>
          </div>
        </div>
      </div>
    </div>

    <!-- MAIN BANNER -->
    <div id="main-banner">
      <h1 id="main-heading">C11 Crypto</h1>
    </div>

    <div class="container">
      <div class="row justify-content-md-center" align="center">
      </div>
    </div>

    <div class="main-container">
      <div class="left-container">
        <table class="table main-table">
          <thead class="table-dark">
            <tr>
              <th scope="col">Asset</th>
              <th scope="col">Units held</th>
              <th scope="col">Current price per unit</th>
              <th scope="col">Value of position</th>
              <th scope="col">Cost of position</th>
              <th scope="col">Unrealized profit/loss</th>
              <th scope="col">Actions</th>
            </tr>
          </thead>
          <!-- MAIN POSITIONS/HOLDINGS TABLE -->
          <tbody id="positions-table">
          </tbody>
          <tr id="userCashBalance">
            <!-- WHERE AVAILABLE CAPITAL IS SHOWN -->
          </tr>
          <tr id="totalPortfolioValue">

          </tr>
        </table>
      </div>


      <!-- ORDERING/PURCHASING DESK -->
      <div class="right-container">
        <h3 class="purchasing-desk">Purchase new asset</h3>
        <div id="trade-container">
          <form id="trade-options">
            <div class="dropdown">
              <button id="assetDropdownHeader" class="btn btn-primary dropdown-toggle" type="button"
                data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Select asset</button>
              <div id="assetDropdownMenu" class="dropdown-menu">
              </div>
            </div>
            <br>
            <h6 id="lastTradedPrice"></h6>
            <br>
            <label class="form-label">Unit amount</label>
            <br>
            <input id="quantityBox" type="number" placeholder="E.g. 2, 5, 30" class="form-control">
            <br>
            <h6 id="or">Or</h6>
            <label class="form-label">Cash amount ($)</label>
            <br>
            <input id="cashBox" type="text" placeholder="E.g. 150, 12000" class="form-control">
          </form>
        </div>
        <div align="center" class="trade-buttons col-12">
          <button id="obtain-quote" type="button" class="btn btn-primary col-7">Obtain quote</button>
        </div>
      </div>
    </div>

    <footer id="footer">
      <p id="github"><a href="https://github.com/joshua-hs">github.com/joshua-hs</a></p>
      <p>Live prices provided by <a href="https://docs.pro.coinbase.com/">Coinbase</a></p>
    </footer> 

    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
      integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
      crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
      integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
      crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
      integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
      crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    
    <script>
    
    "use strict";

  //App begins
  const localhostApiEndpoint = "http://localhost:8080/"
  const coinbaseApiEndpoint = "https://api.pro.coinbase.com/products/"

  const availableAssets = ["Bitcoin", "Ethereum", "Uniswap", "EOS", "Litecoin", "SushiSwap"]

  const assetsTicker = {
      "Bitcoin": "BTC",
      "Ethereum": "ETH",
      "Uniswap": "UNI",
      "EOS": "EOS",
      "Litecoin": "LTC",
      "SushiSwap": "SUSHI"
  }

  let userId = localStorage.getItem("userId");

  console.log("userId: " + userId);

  let tradeInfo;

  let globalPositionInfo;

  let modificationAssetPrice;


  //Load coin selection dropdown
  function loadDropDownMenu() {
      const dropDownMenu = document.getElementById("assetDropdownMenu");
      const dropDownHeader = document.getElementById("assetDropdownHeader");
      const lastTradedPrice = document.getElementById("lastTradedPrice");

      availableAssets.forEach(asset => {
          const dropdownOption = document.createElement("button");
          dropdownOption.className = "dropdown-item";
          dropdownOption.type = "button";
          dropdownOption.id = asset;
          dropdownOption.innerText = asset;

          dropdownOption.addEventListener("click", () => {
              dropDownHeader.innerText = dropdownOption.innerText;
              axios.get(coinbaseApiEndpoint + `/${assetsTicker[asset]}-usd/ticker`)
                  .then(res => {
                      lastTradedPrice.innerText = `Current price of ${asset}: ` + toUSD(res.data.price);
                  })
                  .catch(err => console.log(err));
          })

          dropDownMenu.appendChild(dropdownOption);
      })

  }


  //Load trade confirmation modal
  function loadModal(assetJson, assetName) {

      axios.get(localhostApiEndpoint + "getPositions")
          .then(res => {
              const myPositions = res.data;
              let alreadyOwned = false;
              myPositions.forEach(position => {
                  if ((position.name == assetName) && (position.owner == userId)) {
                      alert(`You already own ${assetName}. Please use the action buttons within the main table to modify your position.`);
                      alreadyOwned = true;
                  }
              })

              if (alreadyOwned) {
                  return;
              } else {
                  $('#quoteModal').modal('show');
                  const asset = assetName;
                  const price = parseFloat(assetJson.price);
                  let units;
                  let cost;
                  console.log("price " + price);
                  console.log(document.getElementById("quantityBox").value);
                  console.log(document.getElementById("cashBox").value);

                  if (document.getElementById("quantityBox").value !== "") {
                      units = parseFloat(document.getElementById("quantityBox").value);
                      cost = price * units;
                  } else {
                      units = parseFloat((document.getElementById("cashBox").value) / price).toFixed(9);
                      cost = parseFloat(document.getElementById("cashBox").value);
                  };

                  document.getElementById("modalAssetName").innerHTML = "Asset: " + asset.bold();
                  document.getElementById("modalQuantity").innerHTML = "Units: " + units.toString().bold();
                  document.getElementById("modalPrice").innerHTML = "Price per unit: " + toUSD(price).bold();
                  document.getElementById("modalCost").innerHTML = "Total order cost: " + toUSD(cost).bold();

                  tradeInfo = {
                      "name": asset,
                      "unitsHeld": units,
                      "cost": cost,
                      "owner": userId
                  }
              }

          }).catch(err => console.log(err));

  }

  // WHY DOESN'T THIS WORK???
  // async function getAvailableCapital() {
//       await axios.get(localhostApiEndpoint + "getAvailableCapital/" + userId)
//       .then(res => {
//           console.log(res.data);
//           return res.data;
//       }).catch(err => console.log(err));
  // }


  function modifyAvailableCapital(capitalAdjustment) {
      const adjustmentJson = {
          "availableCapital": capitalAdjustment
      };
      axios.put(localhostApiEndpoint + "modifyAvailableCapital/" + userId, adjustmentJson)
          .then(res => {
              return res.data.availableCapital;
          }).catch(err => console.log(err));
  }


  function insertNewTrade(trade) {
      axios.get(localhostApiEndpoint + "getAvailableCapital/" + userId)
          .then(res => {
              if (trade.cost > res.data) {
                  alert("You do not have enough capital for this trade.")
              } else {
                  $('#quoteModal').modal('hide');

                  modifyAvailableCapital(trade.cost * -1);

                  axios.post(localhostApiEndpoint + "createPosition", trade)
                      .then(res => {
                          loadTableData();
                      }).catch(err => console.log(err));
              }
          })


  }


  function loadIncreasePositionModal(positionInfo) {
      console.log(positionInfo.value);
      $('#increasePositionModal').modal('show')
      document.getElementById("increasePositionAssetLastTradedPrice").innerText =
          axios.get(coinbaseApiEndpoint + `${positionInfo.name}-usd/ticker`)
              .then(res => {
                  document.getElementById("increasePositionAssetLastTradedPrice").innerText = `Current price of ${positionInfo.name}: ` + toUSD(res.data.price);
                  modificationAssetPrice = res.data.price;
                  document.getElementById("increasePositionCurrentValue").innerText = "Current value of units: " + toUSD(positionInfo.unitsHeld * modificationAssetPrice);
              }).catch(err => console.log(err));

      document.getElementById("increasePositionCurrentUnits").innerText = "Current units held: " + positionInfo.unitsHeld;

      globalPositionInfo = positionInfo;

  }


  function loadDecreasePositionModal(positionInfo) {
      $('#decreasePositionModal').modal('show')
      document.getElementById("decreasePositionQuantityBox").disabled = false;
      document.getElementById("sellEntireHoldingCheckBox").checked = false;
      document.getElementById("decreasePositionAssetLastTradedPrice").innerText =
          axios.get(coinbaseApiEndpoint + `${positionInfo.name}-usd/ticker`)
              .then(res => {
                  document.getElementById("decreasePositionAssetLastTradedPrice").innerText = `Current price of ${positionInfo.name}: ` + toUSD(res.data.price);
                  modificationAssetPrice = res.data.price;
                  document.getElementById("decreasePositionCurrentValue").innerText = "Current value of units: " + toUSD(positionInfo.unitsHeld * modificationAssetPrice);
              }).catch(err => console.log(err));

      document.getElementById("decreasePositionCurrentUnits").innerText = "Current units held: " + positionInfo.unitsHeld;

      globalPositionInfo = positionInfo;

  }


  document.getElementById("sellEntireHoldingCheckBox").addEventListener("change", () => {
      if (document.getElementById("sellEntireHoldingCheckBox").checked) {
          console.log(globalPositionInfo.unitsHeld);
          document.getElementById("decreasePositionQuantityBox").value = globalPositionInfo.unitsHeld;
          document.getElementById("decreasePositionQuantityBox").disabled = true;
      } else {
          document.getElementById("decreasePositionQuantityBox").disabled = false;
      }
  })



  function executeIncreasePosition() {
      const price = modificationAssetPrice;
      let additionalUnits;
      let additionalCost;
      if (document.getElementById("increasePositionQuantityBox").value < 0) {
          alert("You cannot purchase negative units.")
          return;
      } else if (document.getElementById("increasePositionQuantityBox").value !== "") {
          additionalUnits = parseFloat(document.getElementById("increasePositionQuantityBox").value);
          additionalCost = price * additionalUnits;
      } else {
          additionalUnits = parseFloat(document.getElementById("increasePositionQuantityBox").value) / price;
          additionalCost = parseFloat(document.getElementById("increasePositionCashBox").value);
      };

      axios.get(localhostApiEndpoint + "getAvailableCapital/" + userId)
          .then(res => {
              if (additionalCost > res.data) {
                  alert("You do not have enough capital to make this trade.")
              } else {
                  const positionIncreaseJSON = {
                      "name": globalPositionInfo.name,
                      "unitsHeld": additionalUnits,
                      "cost": additionalCost
                  }

                  $('#increasePositionModal').modal('hide');

                  modifyAvailableCapital(positionIncreaseJSON.cost * -1);

                  axios.put(localhostApiEndpoint + "increasePosition/" + globalPositionInfo.id, positionIncreaseJSON)
                      .then(res => {
                          loadTableData();
                      }).catch(err => console.log(err));
              }
          })


  }


  function executeDecreasePosition() {
      const price = modificationAssetPrice;
      let unitsToSell;
      let cashToRealize;
      if (document.getElementById("decreasePositionQuantityBox").value < 0) {
          alert("You cannot sell negative units.")
          return;
      } else if (document.getElementById("decreasePositionQuantityBox").value !== "") {
          unitsToSell = parseFloat(document.getElementById("decreasePositionQuantityBox").value);
          cashToRealize = price * unitsToSell;
      } else {
          unitsToSell = parseFloat(document.getElementById("decreasePositionQuantityBox").value) / price;
          cashToRealize = parseFloat(document.getElementById("decreasePositionCashBox").value);
      };

      if (unitsToSell > globalPositionInfo.unitsHeld) {
          alert("You cannot sell more units than you hold.")
      } else if (unitsToSell == globalPositionInfo.unitsHeld) {
          sellAllUnits();
          return;
      } else {
          const positionDecreaseJSON = {
              "name": globalPositionInfo.name,
              "unitsHeld": unitsToSell,
              "cost": cashToRealize
          }

          $('#decreasePositionModal').modal('hide');

          modifyAvailableCapital(positionDecreaseJSON.cost);

          axios.put(localhostApiEndpoint + "decreasePosition/" + globalPositionInfo.id, positionDecreaseJSON)
              .then(res => {
                  loadTableData();
              }).catch(err => console.log(err));
      }


  }


  //Sell entire holding (DELETE)
  function sellAllUnits() {
      let cashToRealize = globalPositionInfo.unitsHeld * modificationAssetPrice;
      console.log(cashToRealize);

      $('#decreasePositionModal').modal('hide');

      modifyAvailableCapital(cashToRealize);

      axios.delete(localhostApiEndpoint + "removePosition/" + globalPositionInfo.id)
          .then(res => {
              loadTableData();
          }).catch(err => console.log(err));


  }


  //Obtain quote
  document.getElementById("obtain-quote").addEventListener("click", () => {
      const assetName = document.getElementById("assetDropdownHeader").innerText;

      if (assetName == "Select asset") {
          alert("Please choose an asset.")
      } else if ((document.getElementById("quantityBox").value !== "") && (document.getElementById("cashBox").value !== "")) {
          alert("Cannot input both unit and cash amount. Please use one or the other.")
      } else if ((document.getElementById("quantityBox").value < 0)) {
          alert("Cannot purchase zero or negative units.")
      } else {
          axios.get(coinbaseApiEndpoint + `${assetsTicker[assetName]}-usd/ticker`)
              .then(res => {
                  loadModal(res.data, assetsTicker[assetName]);
              })
              .catch(err => console.log(err));
      }

  })


  //Send new position to backend (CREATE)
  document.getElementById("placeTrade").addEventListener("click", () => {
      insertNewTrade(tradeInfo);
  })


  //Send position increase instruction to backend (UPDATE)
  document.getElementById("increasePositionExecute").addEventListener("click", () => {
      executeIncreasePosition();

  })


  //Send position decrease instruction to backend (UPDATE)
  document.getElementById("decreasePositionExecute").addEventListener("click", () => {
      if (document.getElementById("decreasePositionQuantityBox").value > globalPositionInfo.unitsHeld) {
          alert("You cannot sell more units than you hold.")
          return;
      } else {
          executeDecreasePosition();
      }
  })


  //Load main positions table (READ)
  async function loadTableData() {
      const positionsTable = document.getElementById("positions-table");

      axios.get(localhostApiEndpoint + "getPositions")
          .then(res => {
              positionsTable.innerHTML = "";
              const myPositions = res.data;
              myPositions.forEach(position => {
                  if (position.owner == userId) {
                      const newPosition = renderPosition(position);
                      positionsTable.appendChild(newPosition);
                  }
              })
          }).catch(err => console.log(err));


      axios.get(localhostApiEndpoint + "getAvailableCapital/" + userId)
          .then(res => {
              document.getElementById("userCashBalance").innerHTML = "Available capital: " + toUSD(res.data).toString().bold();
          }).catch(err => console.log(err));


  }


  //Load each position within main table
  function renderPosition(position) {
      const newRow = document.createElement("tr");

      const positionAssetName = document.createElement("td");
      positionAssetName.innerText = position.name;

      const positionUnitsHeld = document.createElement("td");
      positionUnitsHeld.innerText = position.unitsHeld;

      const positionCost = document.createElement("td");
      positionCost.innerText = toUSD(position.cost);

      const positionCurrentPrice = document.createElement("td");
      const positionValue = document.createElement("td");
      const positionUnrealized = document.createElement("td");

      axios.get(coinbaseApiEndpoint + `${position.name}-usd/ticker`)
          .then(res => {
              positionCurrentPrice.innerText = toUSD(res.data.price);
              positionValue.innerText = toUSD(res.data.price * positionUnitsHeld.innerText);
              positionUnrealized.innerText = toUSD(res.data.price * positionUnitsHeld.innerText - position.cost);
              if (res.data.price * positionUnitsHeld.innerText - position.cost > 0) {
                  positionUnrealized.className = "gains";
              } else {
                  positionUnrealized.className = "loss";
              }
          }).catch(err => console.log(err));

      const positionIncrease = document.createElement("button");
      positionIncrease.className = "btn btn-success";
      positionIncrease.innerText = "Buy";
      positionIncrease.addEventListener("click", () => {
          loadIncreasePositionModal(position);
      })

      const positionDecrease = document.createElement("button");
      positionDecrease.className = "btn btn-danger";
      positionDecrease.innerText = "Sell";
      positionDecrease.addEventListener("click", () => {
          loadDecreasePositionModal(position);
      })

      const positionActions = document.createElement("td");
      positionActions.appendChild(positionIncrease);
      positionActions.appendChild(positionDecrease);

      newRow.appendChild(positionAssetName);
      newRow.appendChild(positionUnitsHeld);
      newRow.appendChild(positionCurrentPrice);
      newRow.appendChild(positionValue);
      newRow.appendChild(positionCost);
      newRow.appendChild(positionUnrealized);
      newRow.appendChild(positionActions);

      return newRow;
  }


  //Format values to resemble currency
  function toUSD(amount) {
      return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount);
  }

  loadDropDownMenu();
  loadTableData();
    
    </script>
  </body>

</html>